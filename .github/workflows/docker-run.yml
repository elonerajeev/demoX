name: CI - Docker Setup and Run (Infra App)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  docker-job:
    # üëá This is the key change ‚Äî run this job on your own machine or EC2 instance
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ‚úÖ Install Docker (only first time needed, skip if already installed on your runner)
      - name: Install Docker
        run: |
          if ! command -v docker &> /dev/null; then
            echo "Installing Docker..."
            sudo apt-get update
            sudo apt-get remove -y docker docker-engine docker.io containerd runc || true
            sudo apt-get install -y ca-certificates curl gnupg lsb-release
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
              https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            sudo systemctl start docker
          else
            echo "‚úÖ Docker already installed."
          fi
          docker --version

      - name: Pull Docker Image
        run: |
          docker pull elonerajeev/infra-app:latest

      - name: Run Docker Container
        run: |
          # Stop existing container if already running
          if [ "$(docker ps -q -f name=infra-app)" ]; then
            echo "Stopping existing container..."
            docker stop infra-app || true
            docker rm infra-app || true
          fi
          echo "Starting new container..."
          docker run -d -p 8080:8080 --name infra-app elonerajeev/infra-app
          docker ps -a

      - name: How to Access Externally
        run: |
          echo "-----------------------------------------------------------"
          echo "‚úÖ Your container 'infra-app' is running successfully!"
          echo ""
          echo "üåç Access it in browser after deployment:"
          echo "  üëâ http://<YOUR_SERVER_PUBLIC_IP>:8080"
          echo ""
          echo "üõ°Ô∏è Ensure port 8080 is open in your firewall/security group."
          echo "-----------------------------------------------------------"

      - name: Docker Status
        run: |
          echo "Docker ps output:"
          docker ps
          echo ""
          echo "Docker images list:"
          docker images
          echo "curl ifconfig.me"
          curl ifconfig.me
